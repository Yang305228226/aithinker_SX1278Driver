**数据接收序列**

**图10显示了在单一及连续接收操作模式下典型的LoRaTM接收序列。**



![1591806244](resource\1591806244.jpg)

**LORA接收机有两种独特的工作模式：**

**1）单一接收模式**

**2）连续接收模式**



**单一接收操作模式**
在这种模式下，调制解调器在给定的时间窗口内搜索前导码。如果在该时间窗口结束时还未找到前导码，则芯片会产生RxTimeout中断信号并切换回待机模式。时间窗口长度（以符号计）由RegSymbTimeout寄存器定义，必须为4（调制解调器获取前导码锁的最短时间）到1023个符号。缺省值为5。如果在时间窗口内未发现前导码，则会产生RxTimeout中断信号，同时芯片切换回待机模式。在有效负载结束时，如果负载CRC无效，则会产生RxDone中断信号及PayloadCrcError中断信号。然而，即使CRC无效，仍然可以在FIFO数据缓存中写入数据，以便后续进行处理。RxDone中断产生后，芯片切换回待机模式。当RxDone或RxTimeout中断信号产生时，调制解调器也会自动回到待机模式。因此，只有在数据包到达时间窗口为已知的情况下才会使用RX单一接收模式。而在其他情况下，应使用RX连续模式。



**在RX单一模式下，接收到数据包后，应立即关闭PLL和射频模块，以降低功耗。流程如下：**

**1 ）将FifoAddrPtr设置为FifoRxBaseAddr。**

**2 ）静态配置寄存器在睡眠模式、待机模式或FSRx模式下均可写入数据。**

**3 ）通过选择RX单一操作模式，可以启动单一数据包接收操作。**

**4 ）接收机等待接收有效前导码。接收到有效前导码后，接收通路增益即刻被设定。随后将接收到由ValidHeader中断信号表示的有效显式报头后，开始数据包接收。数据包接收完毕后，产生RxDone中断信号。最后，芯片自动恢复到待机模式，以减少功耗。**

**5 ）应检查接收机状态寄存器PayloadCrcError，以保证数据包有效负载的完整性。**

**6 ）如果接收到有效的数据包，则应该读取FIFO数据缓存中的数据（见下文的有效负载数据提取）。如果后续需要触发单一数据包接收过程，则应该重选RX单一操作模式，以便再次启动接收程序——务必将SPI指针（FifoAddrPtr）重新调整到缓存的接收基地址（FifoRxBaseAddr）。**



**连续接收操作模式**
在连续接收模式下，调制解调器会持续扫描信道，以搜索前导码。每当检测到前导码时，调制解调器都会在收到数据包前对该前导码进行检测及跟踪，然后继续等待检测下一前导码。

如果前导码长度超过寄存器RegPreambleMsb和RegPreambleLsb设定的预计值（按照符号周期测量），则前导码会被丢弃，并重新开始前导码搜索。但在这种场景不会产生中断标志。与单一Rx模式相反，在连续Rx模式下，当产生超时中断时，设备不会进入待机模式。这时，用户必须在设备继续等待有效前导码的同时直接清除中断信号。

注意：被解调字节是按照接收序列写入数据缓存区的。换言之，新数据包的第一个字节会在上一个数据包的最后一个字节之后立即写入。在这种模式下，接收地址指针将不会重置。因此，关联微控制器MCU必须对地址指针进行处理，以保证FIFO数据缓存不会溢出。



在连续模式下，被接收数据包的处理序列如下：
1. 在睡眠或待机模式下，选择RXCONT模式。
2. 收到有效报头之后，紧接着会产生RxDone中断。芯片一直处于RXCONT模式，等待下一个LoRaTM数据包。
3. 检查PayloadCrcError标志，以验证数据包完整性。
4. 如果数据包被正确接收，则可以读取FIFO数据缓存（见下文）。
5. 接收过程（步骤2-4）可重复，或在需要的情况下可退出接收机操作模式。在连续操作模式下，仅可查看最后一个接收数据包对应的状态信息。换言之，应在接收到下一个RxDone信号之前读取对应寄存器。



在连续操作模式下，仅可查看最后一个接收数据包对应的状态信息。换言之，应在接收到下一个RxDone信号之前读取对应寄存器。



**从FIFO数据缓存提取有效负载数据**
为从FIFO数据缓存检索接收数据，用户必须保证状态寄存器RegIrqFlags中的ValidHeader、PayloadCrcError、RxDone及RxTimeout等中断信号未意外生效，以确保数据包接收成功终止（即不应设置任何标志）。
如果发生错误，应跳过以下步骤，同时丢弃数据包。为从FIFO数据缓存检索到有效的接收数据，用户必须：

 RegRxNbBytes：表示到现在为止已接收到的字节数。

 RegFifoAddrPtr：精确标志了LoRa调制解调器接收数据写入位置的动态指针。

 将RegFifoAddrPtr设置为RegFifoRxCurrentAddr：表示将FIFO指针指向FIFO数据缓存中最后接收的数据包的存储位置。可以通过RegRxNbBytes次读取寄存器RegFifo中的数据，以提取数据包的有效负载数据。

 或者，可以手动将RegFifoAddrPtr设置为RegFifoRxByteAddr减去RegRxNbBytes的值，使该指针从当前数据包开始，一直指向最后接收的数据包的存储位置。可以通过RegRxNbBytes次读取寄存器RegFifo中的地址，以提取数据包的有效负载字节。



